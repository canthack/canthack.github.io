---
author: bohblesku
comments: true
date: 2011-02-13 11:12:11+00:00
layout: post
slug: pwn-pwm
title: pwn PWM
wordpress_id: 306
categories:
- Programming
---

Not really much of a hack for this hack session, but still a lot of fun - PWM output control in a PIC microcontroller for a configurable H bridge / 3 phase bridge. A High/Low pair of outputs is set up in complementary mode with a dead time (where in a transition, both outputs are off for a short period of time) so we never get the scenario with slow reacting FET's, of both High and Low sides of the bridge being on at the same time hence shorting the circuit.

[caption id="attachment_316" align="alignnone" width="300" caption="Oscilloscope Complementary H/L PWM trace"][![](http://canthack.org/uploads/20101218_004-300x225.jpg)](http://canthack.org/2011/02/pwn-pwm/20101218_004/)[/caption]

The simplest implementation here is a H bridge - we have two High-Low bridges with say a DC motor connected across the centre of the bridge. In that case, we complementary control PWM on one side of the H bridge, and we logic control the other side. We control the duty cycle of the PWM which controls the speed of the motor, and we could swap sides that are being PWM and Logic, to make the motor move in the opposite direction.

Finally, we throw in some varying setpoints to alter the duty cycle. I also added some code to allow the motor to move in either direction from a positive or negative set point.

And there we have it;
[sourcecode language="cpp"]
void pwmForward(void) {
  P1OVDCONbits.POVD1L = 1;    /* PWM */
  P1OVDCONbits.POVD1H = 1;    /* PWM */
  P1OVDCONbits.POVD2L = 0;    /* Override */
  P1OVDCONbits.POVD2H = 0;    /* Override */
}

void pwmReverse(void) {
  P1OVDCONbits.POVD1L = 0;    /* Override */
  P1OVDCONbits.POVD1H = 0;    /* Override */
  P1OVDCONbits.POVD2L = 1;    /* PWM */
  P1OVDCONbits.POVD2H = 1;    /* PWM */
}
[/sourcecode]
A gotcha - Using Port IO on the logic side left the output at a mid level - there is however an override register which sets or clears the logic level so use this rather than conventional TRIS/LAT when using PWM. (It is all in the documentation, but hack night is about beer and fun, not documents!)
[sourcecode language="cpp"]
/* Low side active when override active */
P1OVDCONbits.POUT1L = 1;

/* High side inactive when override active */
P1OVDCONbits.POUT1H = 0;

/* Low side active when override active */
P1OVDCONbits.POUT2L = 1;

/* High side inactive when override active */
P1OVDCONbits.POUT2H = 0;
[/sourcecode]
